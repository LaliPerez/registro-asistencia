<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Training Attendance Record</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React and ReactDOM (UMD versions for browser compatibility) -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    
    <!-- Babel for JSX transpilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- jsPDF and autoTable plugin for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.1.1",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.1.1/",
    "react/": "https://aistudiocdn.com/react@^19.1.1/"
  }
}
</script>
</head>
  <body class="bg-gray-900">
    <div id="root"></div>
    
    <script type="text/babel">
      const { useState, useCallback, useRef, useEffect, useImperativeHandle } = React;

      // --- Icons ---
      const SaveIcon = () => (
        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
        </svg>
      );

      const ClearIcon = () => (
        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
        </svg>
      );

      const ExportIcon = () => (
        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
        </svg>
      );

      // --- SignaturePad Component ---
      const SignaturePad = React.forwardRef(({ width = 400, height = 200 }, ref) => {
        const canvasRef = useRef(null);
        const [isDrawing, setIsDrawing] = useState(false);
        const [isEmpty, setIsEmpty] = useState(true);

        const getCanvasContext = () => {
          const canvas = canvasRef.current;
          if (!canvas) return null;
          return canvas.getContext('2d');
        };

        const clearCanvas = () => {
          const context = getCanvasContext();
          if (context && canvasRef.current) {
            context.clearRect(0, 0, canvasRef.current.width, canvasRef.current.height);
            setIsEmpty(true);
          }
        };

        const getSignatureDataURL = () => {
          if (isEmpty || !canvasRef.current) return null;
          return canvasRef.current.toDataURL('image/png');
        };

        useImperativeHandle(ref, () => ({
          clear: clearCanvas,
          getSignature: getSignatureDataURL,
          get isEmpty() {
            return isEmpty;
          }
        }));

        const getCoords = (event) => {
          if (!canvasRef.current) return null;
          const rect = canvasRef.current.getBoundingClientRect();
          if (event instanceof MouseEvent) {
            return { x: event.clientX - rect.left, y: event.clientY - rect.top };
          }
          if (event.touches && event.touches.length > 0) {
            return { x: event.touches[0].clientX - rect.left, y: event.touches[0].clientY - rect.top };
          }
          return null;
        };
        
        const startDrawing = (event) => {
          event.preventDefault();
          const coords = getCoords(event);
          if (!coords) return;
          const context = getCanvasContext();
          if (!context) return;
          
          context.beginPath();
          context.moveTo(coords.x, coords.y);
          setIsDrawing(true);
          setIsEmpty(false);
        };
        
        const draw = (event) => {
          if (!isDrawing) return;
          event.preventDefault();
          const coords = getCoords(event);
          if (!coords) return;
          const context = getCanvasContext();
          if (!context) return;

          context.lineTo(coords.x, coords.y);
          context.stroke();
        };
        
        const stopDrawing = (event) => {
          event.preventDefault();
          const context = getCanvasContext();
          if (!context) return;

          context.closePath();
          setIsDrawing(false);
        };

        useEffect(() => {
          const canvas = canvasRef.current;
          if (!canvas) return;
          
          const context = canvas.getContext('2d');
          if (!context) return;

          const resizeCanvas = () => {
            const { width, height } = canvas.getBoundingClientRect();
            if(canvas.width !== width || canvas.height !== height) {
              const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
              canvas.width = width;
              canvas.height = height;
              context.putImageData(imageData, 0, 0);
              context.strokeStyle = '#FFFFFF';
              context.lineWidth = 2;
              context.lineCap = 'round';
              context.lineJoin = 'round';
            }
          };

          window.addEventListener('resize', resizeCanvas);
          resizeCanvas();
          context.strokeStyle = '#FFFFFF';
          context.lineWidth = 2;
          context.lineCap = 'round';
          context.lineJoin = 'round';
          
          canvas.addEventListener('mousedown', startDrawing);
          canvas.addEventListener('mousemove', draw);
          canvas.addEventListener('mouseup', stopDrawing);
          canvas.addEventListener('mouseleave', stopDrawing);

          canvas.addEventListener('touchstart', startDrawing, { passive: false });
          canvas.addEventListener('touchmove', draw, { passive: false });
          canvas.addEventListener('touchend', stopDrawing, { passive: false });

          return () => {
            window.removeEventListener('resize', resizeCanvas);
            canvas.removeEventListener('mousedown', startDrawing);
            canvas.removeEventListener('mousemove', draw);
            canvas.removeEventListener('mouseup', stopDrawing);
            canvas.removeEventListener('mouseleave', stopDrawing);
            canvas.removeEventListener('touchstart', startDrawing);
            canvas.removeEventListener('touchmove', draw);
            canvas.removeEventListener('touchend', stopDrawing);
          };
        }, [isDrawing]);

        return (
          <div className="relative w-full h-48 bg-gray-700 rounded-lg border-2 border-dashed border-gray-500 cursor-crosshair overflow-hidden">
            <canvas ref={canvasRef} className="w-full h-full" />
            {isEmpty && (
              <div className="absolute top-0 left-0 w-full h-full flex items-center justify-center text-gray-400 pointer-events-none">
                Firme aquí
              </div>
            )}
          </div>
        );
      });

      // --- AttendanceForm Component ---
      const InputField = ({ id, label, type = 'text', value, onChange }) => (
        <div>
          <label htmlFor={id} className="block text-sm font-medium text-gray-300 mb-1">{label}</label>
          <input
            type={type}
            id={id}
            name={id}
            value={value}
            onChange={onChange}
            className="w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
            required
          />
        </div>
      );

      const AttendanceForm = ({ onSave, disabled }) => {
        const getInitialState = () => ({
          trainingDate: new Date().toISOString().split('T')[0],
          participantName: '',
          participantPosition: '',
          participantEmpresa: '',
        });

        const [formData, setFormData] = useState(getInitialState());
        const [error, setError] = useState('');
        const signaturePadRef = useRef(null);

        const handleChange = (e) => {
          const { name, value } = e.target;
          setFormData(prev => ({ ...prev, [name]: value }));
        };

        const handleClear = () => {
          setFormData(getInitialState());
          signaturePadRef.current?.clear();
          setError('');
        };

        const handleSubmit = (e) => {
          e.preventDefault();
          const signature = signaturePadRef.current?.getSignature();

          if (signaturePadRef.current?.isEmpty || !signature) {
            setError('La firma del participante es obligatoria.');
            return;
          }
          
          setError('');
          onSave({ ...formData, signature });
          handleClear();
        };

        return (
          <div className="bg-gray-800 p-6 rounded-xl shadow-lg relative">
            {disabled && (
              <div className="absolute inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-10 rounded-xl cursor-not-allowed">
                <p className="text-lg text-gray-300 font-medium text-center p-4">
                  Primero ingrese el nombre de la capacitación.
                </p>
              </div>
            )}
            <h2 className="text-2xl font-bold text-white mb-6">Nuevo Registro de Asistente</h2>
            <form onSubmit={handleSubmit} className="space-y-4">
              <fieldset disabled={disabled}>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div className="md:col-span-2">
                    <InputField id="participantName" label="Nombre del Participante" value={formData.participantName} onChange={handleChange} />
                  </div>
                  <InputField id="participantPosition" label="Cargo" value={formData.participantPosition} onChange={handleChange} />
                  <InputField id="participantEmpresa" label="Empresa" value={formData.participantEmpresa} onChange={handleChange} />
                   <div className="md:col-span-2">
                      <InputField id="trainingDate" label="Fecha de Capacitación" type="date" value={formData.trainingDate} onChange={handleChange} />
                  </div>
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-300 mb-1">Firma del Participante</label>
                  <SignaturePad ref={signaturePadRef} />
                </div>

                {error && <p className="text-red-400 text-sm">{error}</p>}

                <div className="flex items-center justify-end space-x-4 pt-4">
                  <button
                    type="button"
                    onClick={handleClear}
                    className="flex items-center justify-center px-4 py-2 bg-gray-600 text-white font-semibold rounded-md hover:bg-gray-500 transition duration-200"
                  >
                    <ClearIcon />
                    Limpiar
                  </button>
                  <button
                    type="submit"
                    className="flex items-center justify-center px-4 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-500 transition duration-200"
                  >
                    <SaveIcon />
                    Guardar
                  </button>
                </div>
              </fieldset>
            </form>
          </div>
        );
      };

      // --- RecordsTable Component ---
      const RecordsTable = ({ records, onExport }) => {
        return (
          <div className="bg-gray-800 p-6 rounded-xl shadow-lg mt-8 lg:mt-0">
            <div className="flex justify-between items-center mb-6">
              <h2 className="text-2xl font-bold text-white">Registros Guardados</h2>
              <button
                onClick={onExport}
                disabled={records.length === 0}
                className="flex items-center justify-center px-4 py-2 bg-green-600 text-white font-semibold rounded-md hover:bg-green-500 transition duration-200 disabled:bg-gray-500 disabled:cursor-not-allowed"
              >
                <ExportIcon />
                Exportar a PDF
              </button>
            </div>

            <div className="overflow-x-auto">
              {records.length === 0 ? (
                <p className="text-gray-400 text-center py-8">No hay registros aún. Agregue uno usando el formulario.</p>
              ) : (
                <table className="min-w-full divide-y divide-gray-700">
                  <thead className="bg-gray-700/50">
                    <tr>
                      <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Curso</th>
                      <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Participante</th>
                      <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Fecha</th>
                      <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Firma</th>
                    </tr>
                  </thead>
                  <tbody className="bg-gray-800 divide-y divide-gray-700">
                    {records.map((record) => (
                      <tr key={record.id} className="hover:bg-gray-700/50 transition-colors">
                        <td className="px-6 py-4 whitespace-nowrap">
                          <div className="text-sm font-medium text-white">{record.courseName}</div>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap">
                          <div className="text-sm text-white">{record.participantName}</div>
                          <div className="text-xs text-gray-400">{record.participantPosition} - {record.participantEmpresa}</div>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-300">{record.trainingDate}</td>
                        <td className="px-6 py-4 whitespace-nowrap">
                          <img src={record.signature} alt="Signature" className="w-28 h-14 object-contain bg-white rounded-md p-1" />
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              )}
            </div>
          </div>
        );
      };

      // --- App Component ---
      const App = () => {
        const [records, setRecords] = useState([]);
        const [courseName, setCourseName] = useState('');

        const handleCourseNameChange = (e) => {
          setCourseName(e.target.value);
        };

        const handleSaveRecord = useCallback((newRecordData) => {
          if (!courseName) return;
          
          const newRecord = {
            ...newRecordData,
            courseName,
            id: new Date().toISOString() + Math.random(),
          };
          setRecords(prevRecords => [newRecord, ...prevRecords]);
        }, [courseName]);

        const handleExportPDF = useCallback(() => {
          if (records.length === 0) return;

          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();

          doc.setFontSize(18);
          doc.text(`Registro de Asistencia: ${courseName}`, 14, 22);
          doc.setFontSize(11);
          doc.setTextColor(100);
          doc.text(`Fecha de exportación: ${new Date().toLocaleDateString()}`, 14, 30);

          doc.autoTable({
            startY: 38,
            head: [['#', 'Participante', 'Cargo', 'Empresa', 'Fecha', 'Firma']],
            body: records.map((r, i) => [
              i + 1,
              r.participantName,
              r.participantPosition,
              r.participantEmpresa,
              r.trainingDate,
              '' // Empty cell for signature image
            ]),
            theme: 'grid',
            headStyles: {
              fillColor: [30, 41, 59], // gray-800
              textColor: [255, 255, 255],
            },
            styles: {
              halign: 'center',
              valign: 'middle'
            },
            columnStyles: {
              0: { halign: 'center', cellWidth: 10 },
              1: { halign: 'left' },
              2: { halign: 'left' },
              3: { halign: 'left' },
              4: { halign: 'center' },
              5: { cellWidth: 40, minCellHeight: 20 }, // Signature column
            },
            didDrawCell: (data) => {
              if (data.section === 'body' && data.column.index === 5) {
                const record = records[data.row.index];
                if (record?.signature) {
                  const base64Img = record.signature;
                  const imgWidth = 35;
                  const imgHeight = 15;
                  const x = data.cell.x + (data.cell.width - imgWidth) / 2;
                  const y = data.cell.y + (data.cell.height - imgHeight) / 2;
                  doc.addImage(base64Img, 'PNG', x, y, imgWidth, imgHeight);
                }
              }
            },
          });

          const safeCourseName = courseName.replace(/[^a-z0-9]/gi, '_').toLowerCase();
          doc.save(`registro_asistencia_${safeCourseName}.pdf`);

        }, [records, courseName]);

        return (
          <div className="min-h-screen text-white font-sans p-4 sm:p-6 lg:p-8">
            <div className="container mx-auto">
              <header className="text-center mb-8">
                <h1 className="text-4xl font-extrabold tracking-tight">Registro de Asistencia a Capacitaciones</h1>
                <p className="text-gray-400 mt-2">Una solución moderna para registrar y gestionar la asistencia.</p>
              </header>

              <section className="mb-8 bg-gray-800 p-6 rounded-xl shadow-lg">
                <h2 className="text-xl font-bold text-white mb-4">Información de la Capacitación</h2>
                <div>
                  <label htmlFor="sessionCourseName" className="block text-sm font-medium text-gray-300 mb-1">Nombre del curso/capacitación</label>
                  <input
                    type="text"
                    id="sessionCourseName"
                    name="sessionCourseName"
                    value={courseName}
                    onChange={handleCourseNameChange}
                    placeholder="Escriba el nombre del curso aquí para habilitar el formulario"
                    className="w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                  />
                </div>
              </section>
              
              <main className="grid grid-cols-1 lg:grid-cols-5 gap-8">
                <div className="lg:col-span-2">
                  <AttendanceForm onSave={handleSaveRecord} disabled={!courseName.trim()} />
                </div>
                <div className="lg:col-span-3">
                  <RecordsTable records={records} onExport={handleExportPDF} />
                </div>
              </main>

              <footer className="text-center mt-12 text-gray-500 text-sm">
                <p>Desarrollado con React y Tailwind CSS.</p>
              </footer>
            </div>
          </div>
        );
      };

      // --- Mount the App ---
      const rootElement = document.getElementById('root');
      if (!rootElement) {
        throw new Error("Could not find root element to mount to");
      }

      const root = ReactDOM.createRoot(rootElement);
      root.render(
        <React.StrictMode>
          <App />
        </React.StrictMode>
      );
    </script>
  </body>
</html>
